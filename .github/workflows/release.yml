name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      changelog: ${{ steps.changelog.outputs.content }}
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Extract version from tag
        id: extract
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Release version: $VERSION"
      
      - name: Check Cargo.toml version matches
        run: |
          CARGO_VERSION=$(grep '^version =' cli/Cargo.toml | head -1 | cut -d'"' -f2)
          TAG_VERSION="${{ steps.extract.outputs.version }}"
          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo "‚ùå Version mismatch!"
            echo "Cargo.toml: $CARGO_VERSION"
            echo "Git tag: $TAG_VERSION"
            exit 1
          fi
          echo "‚úÖ Versions match: $CARGO_VERSION"
      
      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ steps.extract.outputs.version }}"
          # Extract section from CHANGELOG.md between this version and next version header
          CONTENT=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$ d')
          # Save to file for multiline output
          echo "$CONTENT" > changelog.txt
          # Set output
          echo "content<<EOF" >> $GITHUB_OUTPUT
          cat changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  run-qa:
    name: Run Full QA Suite
    needs: validate-release
    uses: ./.github/workflows/qa.yml
    secrets: inherit

  build-binaries:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    needs: [validate-release, run-qa]
    
    strategy:
      matrix:
        include:
          - name: Linux x64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: agentic-p-linux-x64
          
          - name: macOS x64
            os: macos-latest
            target: x86_64-apple-darwin
            artifact: agentic-p-macos-x64
          
          - name: macOS ARM64
            os: macos-latest
            target: aarch64-apple-darwin
            artifact: agentic-p-macos-arm64
          
          - name: Windows x64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: agentic-p-windows-x64.exe
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Install Just
        uses: extractions/setup-just@v3
        with:
          just-version: '1.37.0'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache target directory
        uses: actions/cache@v5
        with:
          path: cli/target
          key: ${{ runner.os }}-${{ matrix.target }}-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}
        working-directory: ./cli
      
      - name: Strip binary (Unix)
        if: runner.os != 'Windows'
        run: strip cli/target/${{ matrix.target }}/release/agentic-p
      
      - name: Rename binary (Unix)
        if: runner.os != 'Windows'
        run: |
          mv cli/target/${{ matrix.target }}/release/agentic-p ${{ matrix.artifact }}
      
      - name: Rename binary (Windows)
        if: runner.os == 'Windows'
        run: |
          mv cli/target/${{ matrix.target }}/release/agentic-p.exe ${{ matrix.artifact }}
      
      - name: Generate SHA256 checksum
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            certutil -hashfile ${{ matrix.artifact }} SHA256 | findstr /v ":" > ${{ matrix.artifact }}.sha256
          else
            shasum -a 256 ${{ matrix.artifact }} > ${{ matrix.artifact }}.sha256
          fi
        shell: bash
      
      - name: Upload binary artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}
      
      - name: Upload checksum artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact }}.sha256
          path: ${{ matrix.artifact }}.sha256

  #############################################################################
  # PYTHON PACKAGES (Placeholder - Not Published Yet)
  #############################################################################
  # The Python packages (analytics, agentic_logging) are internal libraries.
  # The main distribution is the Rust CLI binary (agentic-p).
  #
  # Future: If we decide to publish Python packages to PyPI:
  # - Add build-python-wheels job
  # - Add publish-pypi job with manual approval gate
  # - Configure PYPI_API_TOKEN secret
  #############################################################################

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-release, build-binaries]
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: ./artifacts
      
      - name: Flatten artifacts
        run: |
          mkdir -p release
          find artifacts -type f -exec mv {} release/ \;
          ls -lh release/
      
      - name: Generate combined checksums file
        run: |
          cd release
          cat *.sha256 > checksums.txt
          cat checksums.txt
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ needs.validate-release.outputs.version }}
          body: ${{ needs.validate-release.outputs.changelog }}
          draft: false
          prerelease: ${{ contains(needs.validate-release.outputs.version, 'rc') || contains(needs.validate-release.outputs.version, 'beta') || contains(needs.validate-release.outputs.version, 'alpha') }}
          files: |
            release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-crate:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: [create-release]
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Publish to crates.io
        # Will skip gracefully if CARGO_REGISTRY_TOKEN is not configured
        run: |
          if [ -n "$CARGO_REGISTRY_TOKEN" ]; then
            cargo publish --token "$CARGO_REGISTRY_TOKEN"
          else
            echo "‚è≠Ô∏è Skipping crates.io publish - CARGO_REGISTRY_TOKEN not configured"
          fi
        working-directory: ./cli
        continue-on-error: true
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

