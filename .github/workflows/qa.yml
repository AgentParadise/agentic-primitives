name: QA

on:
  pull_request:
  push:
    branches: [main, feat/*]
  workflow_dispatch:

# Cancel in-progress runs on same PR/branch
concurrency:
  group: qa-${{ github.ref }}
  cancel-in-progress: true

jobs:
  #############################################################################
  # PYTHON JOBS - Matrix strategy for all packages
  #############################################################################

  python-packages:
    name: Python ${{ matrix.package.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - name: "Events"
            path: "packages/events"
            python: "3.11"
            pytest-args: "-x -q"

          - name: "Isolation"
            path: "packages/isolation"
            python: "3.11"
            pytest-args: "-x -q --ignore=tests/integration"

          - name: "Logging"
            path: "packages/logging"
            python: "3.11"
            pytest-args: "-x -q --cov-fail-under=90"
            typecheck: true

          - name: "Security"
            path: "packages/security"
            python: "3.11"
            pytest-args: "-x -q"

          - name: "Settings"
            path: "packages/settings"
            python: "3.11"
            pytest-args: "-x -q"

          - name: "Workspace"
            path: "packages/workspace"
            python: "3.11"
            pytest-args: "-x -q"

          - name: "Analytics Service"
            path: "services/analytics"
            python: "3.11"
            pytest-args: "-x -q --cov-fail-under=80"
            typecheck: true

    steps:
      - uses: actions/checkout@v6

      - name: Setup UV
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "${{ matrix.package.path }}/uv.lock"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.package.python }}

      - name: Install dependencies
        working-directory: ./${{ matrix.package.path }}
        run: uv sync --all-extras

      - name: Check formatting
        working-directory: ./${{ matrix.package.path }}
        run: uv run ruff format --check .

      - name: Lint
        working-directory: ./${{ matrix.package.path }}
        run: uv run ruff check .

      - name: Type check
        if: matrix.package.typecheck
        working-directory: ./${{ matrix.package.path }}
        run: uv run mypy .

      - name: Run tests
        working-directory: ./${{ matrix.package.path }}
        run: uv run pytest ${{ matrix.package.pytest-args }}

  python-hooks:
    name: Python Hooks & Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup UV
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Check Hook Files
        run: |
          uv tool install ruff
          uv tool run ruff format --check plugins/sdlc/hooks/**/*.py plugins/workspace/hooks/handlers/*.py
          uv tool run ruff check plugins/sdlc/hooks/**/*.py plugins/workspace/hooks/handlers/*.py

      - name: Run Unit Tests
        working-directory: ./tests/unit/claude/hooks
        run: |
          uv sync --all-extras
          uv run pytest -x -q

  #############################################################################
  # VALIDATION JOB - Validates plugin schemas
  #############################################################################

  validate-primitives:
    name: Validate Primitives
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup UV
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Validate plugin schemas
        run: |
          if [ -f "scripts/validate_plugins.py" ]; then
            uv run python scripts/validate_plugins.py
          else
            echo "Plugin validation script not yet available, skipping"
            exit 0
          fi

  #############################################################################
  # SUMMARY JOB - Required status check for PRs
  #############################################################################

  qa-success:
    name: QA Success
    if: always()
    needs:
      - python-packages
      - python-hooks
      - validate-primitives
    runs-on: ubuntu-latest
    steps:
      - name: Check all jobs
        run: |
          # Check for failures
          if [[ "${{ needs.python-packages.result }}" == "failure" ]] || \
             [[ "${{ needs.python-hooks.result }}" == "failure" ]] || \
             [[ "${{ needs.validate-primitives.result }}" == "failure" ]]; then
            echo "QA checks failed"
            exit 1
          fi

          # Check for cancellations
          if [[ "${{ needs.python-packages.result }}" == "cancelled" ]] || \
             [[ "${{ needs.python-hooks.result }}" == "cancelled" ]] || \
             [[ "${{ needs.validate-primitives.result }}" == "cancelled" ]]; then
            echo "QA checks were cancelled"
            exit 1
          fi

          echo "All QA checks passed!"

      - name: Write summary
        run: |
          echo "## QA Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Packages | ${{ needs.python-packages.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Hooks | ${{ needs.python-hooks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Primitives | ${{ needs.validate-primitives.result }} |" >> $GITHUB_STEP_SUMMARY
