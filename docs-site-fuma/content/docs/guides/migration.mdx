# Migrating from V1 to V2

Guide for migrating existing V1 primitives to the simplified V2 architecture.

## Overview

V2 simplifies the primitive structure while maintaining compatibility with existing build outputs. This guide covers the key changes and migration steps.

## Key Changes

| Aspect | V1 | V2 |
|--------|-----|-----|
| **File Structure** | `commands/qa/review/review.prompt.v1.md` | `commands/qa/review.md` |
| **Metadata** | Separate `.meta.yaml` | Frontmatter in markdown |
| **Levels** | Level 1-4 hierarchy | Flat categories |
| **Tool Specs** | Provider-specific | Standard `tool.yaml` |
| **CLI** | `agentic-p-v1` | `agentic-p` |

## Migration Strategy

### Option 1: Manual Migration (Recommended)

Best for:
- Small number of primitives (< 10)
- Custom modifications needed
- Learning V2 structure

### Option 2: Automated Migration

Best for:
- Large number of primitives (> 10)
- Bulk migration
- Preserving exact content

**Note**: Automated migration tool coming in Phase 2.

---

## Manual Migration Steps

### Step 1: Identify Primitives to Migrate

```bash
# List V1 commands
ls primitives/v1/commands/*/*/

# List V1 skills
ls primitives/v1/skills/*/*/
```

### Step 2: Migrate a Command

#### V1 Structure

```
primitives/v1/commands/qa/review/
‚îú‚îÄ‚îÄ review.prompt.v1.md
‚îî‚îÄ‚îÄ review.meta.yaml
```

**`review.meta.yaml`**:
```yaml
id: commands-qa-review
version: 1
level: 2
purpose: Workflow
description: Review code for quality and best practices
model: sonnet
allowed_tools:
  - Read
  - Grep
  - Bash
```

**`review.prompt.v1.md`**:
```markdown
# Review

## Purpose
*Level 2 (Workflow)*

Review code for quality...
```

#### V2 Structure

```
primitives/v2/commands/qa/
‚îî‚îÄ‚îÄ review.md
```

**`review.md`**:
```markdown
---
description: Review code for quality and best practices
model: sonnet
allowed-tools: Read, Grep, Bash
---

# Review

Review code for quality...
```

#### Migration Process

1. **Create V2 file**:
```bash
agentic-p new command qa review \
  --description "Review code for quality and best practices" \
  --model sonnet \
  --allowed-tools "Read, Grep, Bash" \
  --non-interactive
```

2. **Copy content**:
```bash
# Extract content from V1 (skip Level/Purpose sections)
# Copy to V2 file, updating as needed
```

3. **Validate**:
```bash
agentic-p validate primitives/v2/commands/qa/review.md
```

### Step 3: Migrate a Skill

#### V1 Structure

```
primitives/v1/skills/testing/testing-expert/
‚îú‚îÄ‚îÄ testing-expert.skill.v1.md
‚îî‚îÄ‚îÄ testing-expert.meta.yaml
```

**`testing-expert.meta.yaml`**:
```yaml
id: skills-testing-testing-expert
version: 1
description: Expert knowledge in testing best practices
model: sonnet
expertise:
  - TDD
  - BDD
  - Coverage Analysis
```

#### V2 Structure

```
primitives/v2/skills/testing/
‚îî‚îÄ‚îÄ testing-expert.md
```

**`testing-expert.md`**:
```markdown
---
description: Expert knowledge in testing best practices
model: sonnet
expertise:
  - TDD
  - BDD
  - Coverage Analysis
---

# Testing Expert

...
```

### Step 4: Migrate a Tool

#### V1 Structure

```
primitives/v1/tools/scrape/firecrawl-scraper/
‚îú‚îÄ‚îÄ firecrawl_scraper.py
‚îú‚îÄ‚îÄ pyproject.toml
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ firecrawl-scraper.tool.yaml  # Provider-specific
```

#### V2 Structure

```
primitives/v2/tools/scrape/firecrawl-scraper/
‚îú‚îÄ‚îÄ impl.py
‚îú‚îÄ‚îÄ pyproject.toml
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ tool.yaml  # Standard spec
```

**Changes**:
1. Rename `firecrawl_scraper.py` ‚Üí `impl.py`
2. Update `tool.yaml` to standard format (see `tool-spec.v1.json`)
3. Keep `pyproject.toml` and `README.md` mostly unchanged

---

## Field Mapping

### Commands

| V1 Field | V2 Field | Notes |
|----------|----------|-------|
| `id` | (removed) | Auto-generated from path |
| `version` | (removed) | Managed by CLI |
| `level` | (removed) | Not used in V2 |
| `purpose` | (removed) | Not used in V2 |
| `description` | `description` | Same |
| `model` | `model` | Same |
| `allowed_tools` (array) | `allowed-tools` (string) | Now comma-separated |
| `tags` | `tags` | Same |

### Skills

| V1 Field | V2 Field | Notes |
|----------|----------|-------|
| `id` | (removed) | Auto-generated from path |
| `version` | (removed) | Managed by CLI |
| `description` | `description` | Same |
| `model` | `model` | Same |
| `expertise` | `expertise` | Same |

### Tools

| V1 Field | V2 Field | Notes |
|----------|----------|-------|
| Provider-specific | Standard `tool.yaml` | See schema |

---

## Content Changes

### Remove V1-Specific Sections

Remove these sections from migrated content:

```markdown
## Purpose
*Level X (Workflow)*

Remove this entire section.
```

```markdown
## Philosophy
### Core Principles

Remove if present in skills.
```

### Update Markdown

- ‚úÖ Keep: Headings, lists, code blocks, examples
- ‚ùå Remove: Level indicators, purpose statements
- üîÑ Update: Tool references if needed

---

## Testing Migrated Primitives

```bash
# 1. Validate
agentic-p validate primitives/v2/commands/qa/review.md

# 2. Build
agentic-p build --provider claude --primitives-version v2

# 3. Compare output
diff -r build/claude/ .claude/

# 4. Install
agentic-p install --provider claude

# 5. Test
# Use in Claude Code to verify functionality
```

---

## Batch Migration Script

For multiple primitives:

```bash
#!/bin/bash
# migrate-v1-to-v2.sh

# List V1 commands
for cmd in primitives/v1/commands/*/*/; do
  category=$(basename $(dirname "$cmd"))
  name=$(basename "$cmd")

  echo "Migrating $category/$name..."

  # Extract metadata from .meta.yaml
  desc=$(grep "description:" "$cmd"*.meta.yaml | cut -d: -f2- | xargs)
  model=$(grep "model:" "$cmd"*.meta.yaml | cut -d: -f2 | xargs)
  tools=$(grep -A 10 "allowed_tools:" "$cmd"*.meta.yaml | grep "  -" | cut -d- -f2 | xargs | tr ' ' ',')

  # Create V2 primitive
  agentic-p new command "$category" "$name" \
    --description "$desc" \
    --model "$model" \
    --allowed-tools "$tools" \
    --non-interactive

  # Copy content (manual review recommended)
  # sed to remove Level/Purpose sections

  echo "‚úì Created primitives/v2/commands/$category/$name.md"
done
```

**Note**: Manual review recommended after batch migration!

---

## Common Issues

### Issue: Allowed Tools Format

**V1**:
```yaml
allowed_tools:
  - Read
  - Grep
```

**V2**:
```yaml
allowed-tools: Read, Grep
```

**Fix**: Convert array to comma-separated string.

### Issue: Missing Description Length

V2 requires 10-200 character descriptions.

**Fix**: Expand or condense description as needed.

### Issue: Tool Spec Format

V1 tool specs are provider-specific. V2 uses standard format.

**Fix**: Rewrite `tool.yaml` using `tool-spec.v1.json` schema or use generator:
```bash
agentic-p new tool {category} {name} --description "..." --non-interactive
```

---

## Checklist

- [ ] Identify primitives to migrate
- [ ] Create V2 structure
- [ ] Migrate metadata to frontmatter
- [ ] Copy and update content
- [ ] Remove V1-specific sections
- [ ] Validate all primitives
- [ ] Build and compare output
- [ ] Test in Claude Code
- [ ] Archive or remove V1 primitives

---

## Rollback Plan

If you need to rollback:

1. **Keep V1 primitives**: Don't delete until V2 is validated
2. **Use V1 CLI**: `agentic-p-v1` still available
3. **Restore builds**: Keep V1 build outputs

---

## Support

- **Documentation**: See the docs site under `docs-site-fuma/content/docs/`
- **Issues**: Check GitHub issues
- **ADRs**: See `docs/adrs/032-v2-simplified-structure.md`

---

## Next Steps

- **[Quick Start](../quick-start.md)** - Get started with V2
- **[Authoring Commands](../authoring/commands.md)** - Create new commands
- **[CLI Reference](../reference/cli.md)** - Full CLI documentation
- **[Frontmatter Reference](../reference/frontmatter.md)** - Field reference
