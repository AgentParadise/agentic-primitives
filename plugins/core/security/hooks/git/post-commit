#!/bin/bash
# Post-commit hook - emit git_commit event with metrics
#
# This hook is called after a commit is made. It emits observability events
# with commit metadata and token estimates for analytics.
#
# IMPORTANT: This hook should never fail a commit, so all analytics logic
# is wrapped in a subshell that can fail independently.

# Wrap everything in a subshell so analytics failures never abort commits
(
  set -uo pipefail

  ANALYTICS_PATH="${ANALYTICS_PATH:-.agentic/analytics/events.jsonl}"
  mkdir -p "$(dirname "$ANALYTICS_PATH")"

  # Get commit info
  COMMIT_HASH=$(git rev-parse HEAD)
  COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -1)
  AUTHOR=$(git log -1 --pretty=%an)
  BRANCH=$(git rev-parse --abbrev-ref HEAD)
  TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

  # Get diff stats (handle first commit case)
  if git rev-parse HEAD~1 >/dev/null 2>&1; then
    STATS=$(git diff --stat HEAD~1 HEAD 2>/dev/null || echo "")
    INSERTIONS=$(echo "$STATS" | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
    DELETIONS=$(echo "$STATS" | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")
    FILES_CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | wc -l | tr -d ' ')

    # Estimate tokens (chars/4 approximation)
    # Use cut -c2- to remove the leading +/- from diff lines before counting
    DIFF_CONTENT=$(git diff HEAD~1 HEAD 2>/dev/null || echo "")
    ADDED_CHARS=$(echo "$DIFF_CONTENT" | grep '^+' | grep -v '^+++' | cut -c2- | wc -c | tr -d ' ')
    REMOVED_CHARS=$(echo "$DIFF_CONTENT" | grep '^-' | grep -v '^---' | cut -c2- | wc -c | tr -d ' ')
  else
    # First commit - show all files as added
    INSERTIONS=$(git diff --cached --stat 2>/dev/null | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
    DELETIONS="0"
    FILES_CHANGED=$(git diff --cached --name-only 2>/dev/null | wc -l | tr -d ' ')
    ADDED_CHARS=$(git show --format= HEAD | wc -c | tr -d ' ')
    REMOVED_CHARS="0"
  fi

  # Handle empty values
  INSERTIONS="${INSERTIONS:-0}"
  DELETIONS="${DELETIONS:-0}"
  FILES_CHANGED="${FILES_CHANGED:-0}"
  ADDED_CHARS="${ADDED_CHARS:-0}"
  REMOVED_CHARS="${REMOVED_CHARS:-0}"

  TOKENS_ADDED=$((ADDED_CHARS / 4))
  TOKENS_REMOVED=$((REMOVED_CHARS / 4))

  # Get session_id from environment if available
  SESSION_ID="${CLAUDE_SESSION_ID:-${AEF_SESSION_ID:-unknown}}"

  # Escape JSON strings (with fallback if python3 is not available)
  escape_json() {
    if command -v python3 >/dev/null 2>&1; then
      printf '%s' "$1" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))'
    else
      # Simple fallback: escape quotes, backslashes, and control characters
      local escaped
      escaped=$(printf '%s' "$1" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/	/\\t/g' | tr '\n' ' ')
      printf '"%s"' "$escaped"
    fi
  }

  COMMIT_MESSAGE_JSON=$(escape_json "$COMMIT_MESSAGE")
  AUTHOR_JSON=$(escape_json "$AUTHOR")

  # Emit JSONL event
  echo "{\"timestamp\":\"$TIMESTAMP\",\"event_type\":\"git_commit\",\"session_id\":\"$SESSION_ID\",\"commit_hash\":\"$COMMIT_HASH\",\"commit_message\":$COMMIT_MESSAGE_JSON,\"author\":$AUTHOR_JSON,\"branch\":\"$BRANCH\",\"files_changed\":$FILES_CHANGED,\"insertions\":$INSERTIONS,\"deletions\":$DELETIONS,\"estimated_tokens_added\":$TOKENS_ADDED,\"estimated_tokens_removed\":$TOKENS_REMOVED}" >> "$ANALYTICS_PATH"
) || true

exit 0
