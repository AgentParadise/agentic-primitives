#!/bin/bash
# Post-merge hook - track code reaching stable branches
#
# This hook is called after a merge is completed. It tracks when code
# reaches stable branches (main, master, staging, etc.) for analytics.

ANALYTICS_PATH="${ANALYTICS_PATH:-.agentic/analytics/events.jsonl}"
mkdir -p "$(dirname "$ANALYTICS_PATH")"

TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
TARGET_BRANCH=$(git rev-parse --abbrev-ref HEAD)
MERGE_HEAD=$(git rev-parse MERGE_HEAD 2>/dev/null || git rev-parse HEAD~1)
SESSION_ID="${CLAUDE_SESSION_ID:-${AEF_SESSION_ID:-unknown}}"

# Check if target is a stable branch
IS_STABLE="false"
case "$TARGET_BRANCH" in
  main|master|staging|develop|production|release/*) IS_STABLE="true" ;;
esac

# Get stats about the merge - count commits between merge parents
# HEAD^1 is the previous tip, HEAD^2 is the merged branch tip
if git rev-parse HEAD^2 >/dev/null 2>&1; then
  COMMITS_MERGED=$(git log --oneline HEAD^1..HEAD^2 2>/dev/null | wc -l | tr -d ' ')
else
  COMMITS_MERGED="0"
fi
COMMITS_MERGED="${COMMITS_MERGED:-0}"

# Emit JSONL event
echo "{\"timestamp\":\"$TIMESTAMP\",\"event_type\":\"git_merge_completed\",\"session_id\":\"$SESSION_ID\",\"target_branch\":\"$TARGET_BRANCH\",\"merged_ref\":\"$MERGE_HEAD\",\"is_stable_branch\":$IS_STABLE,\"commits_merged\":$COMMITS_MERGED}" >> "$ANALYTICS_PATH"

exit 0
