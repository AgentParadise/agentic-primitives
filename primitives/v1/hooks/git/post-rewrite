#!/bin/bash
# Post-rewrite hook - track rebased/amended commits
#
# This hook is called after commits are rewritten (rebase, amend, etc.)
# Receives old-sha new-sha pairs on stdin
#
# Args: $1 = "rebase" or "amend"

REWRITE_TYPE="${1:-unknown}"

ANALYTICS_PATH="${ANALYTICS_PATH:-.agentic/analytics/events.jsonl}"
mkdir -p "$(dirname "$ANALYTICS_PATH")"

TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
SESSION_ID="${CLAUDE_SESSION_ID:-${AEF_SESSION_ID:-unknown}}"
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Count rewritten commits from stdin
COMMIT_COUNT=0
while read -r OLD_SHA NEW_SHA EXTRA; do
  COMMIT_COUNT=$((COMMIT_COUNT + 1))
done

# Emit JSONL event
echo "{\"timestamp\":\"$TIMESTAMP\",\"event_type\":\"git_commits_rewritten\",\"session_id\":\"$SESSION_ID\",\"branch\":\"$BRANCH\",\"rewrite_type\":\"$REWRITE_TYPE\",\"commits_rewritten\":$COMMIT_COUNT}" >> "$ANALYTICS_PATH"

exit 0
