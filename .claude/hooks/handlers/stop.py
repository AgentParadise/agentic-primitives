#!/usr/bin/env python3
"""
Stop Handler - Logs when conversation stops normally.

This handler:
1. Receives Stop events from Claude
2. Logs session completion metrics
3. Always allows (no blocking)
"""

import json
import os
import sys
from datetime import datetime, timezone
from pathlib import Path
from typing import Any


def log_analytics(event: dict[str, Any]) -> None:
    """Log to analytics file. Fail-safe - never blocks."""
    try:
        path = Path(os.getenv("ANALYTICS_PATH", ".agentic/analytics/events.jsonl"))
        path.parent.mkdir(parents=True, exist_ok=True)
        with path.open("a") as f:
            f.write(
                json.dumps({"timestamp": datetime.now(timezone.utc).isoformat(), **event}) + "\n"
            )
    except Exception:
        pass


def main() -> None:
    """Main entry point."""
    try:
        input_data = ""
        if not sys.stdin.isatty():
            input_data = sys.stdin.read()

        if not input_data:
            print(json.dumps({"decision": "allow"}))
            return

        event = json.loads(input_data)

        log_analytics(
            {
                "event_type": "agent_stopped",
                "handler": "stop",
                "hook_event": event.get("hook_event_name", "Stop"),
                "session_id": event.get("session_id"),
                "reason": event.get("stop_reason", "normal_completion"),
                "audit": {
                    "transcript_path": event.get("transcript_path"),
                    "cwd": event.get("cwd"),
                },
            }
        )

        print(json.dumps({"decision": "allow"}))

    except Exception as e:
        print(json.dumps({"decision": "allow", "error": str(e)}))


if __name__ == "__main__":
    main()
